name: CI/CD - Compile, Test & Package

on:
  push:
    branches: [ master, main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  compile-and-test:
    name: Compile & Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Display Python version
      run: python -c "import sys; print(f'Python {sys.version}')"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      run: |
        python -m pytest tests/ -v --tb=short --cov=src --cov-report=xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  package:
    name: Package Application
    runs-on: ubuntu-latest
    needs: compile-and-test
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Read VERSION file
      id: version
      run: |
        VERSION=$(cat VERSION)
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version from file: $VERSION"

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install build twine pyinstaller

    - name: Create distribution package
      run: |
        python -m build

    - name: Create PyInstaller standalone binary (Windows)
      if: runner.os == 'Windows'
      run: |
        pyinstaller --onefile --name "BotPersonal" --add-data "src:src" main.py

    - name: Create PyInstaller standalone binary (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        pyinstaller --onefile --name "BotPersonal" --add-data "src:src" main.py

    - name: Create PyInstaller standalone binary (macOS)
      if: runner.os == 'macOS'
      run: |
        pyinstaller --onefile --name "BotPersonal" --add-data "src:src" main.py

    - name: Create source archive
      run: |
        mkdir -p dist
        tar -czf dist/BotPersonal-${{ steps.version.outputs.VERSION }}-source.tar.gz \
          --exclude='.git' \
          --exclude='.venv' \
          --exclude='dist' \
          --exclude='build' \
          --exclude='*.egg-info' \
          --exclude='__pycache__' \
          --exclude='.pytest_cache' \
          .

    - name: Create Windows package
      if: runner.os == 'Windows'
      run: |
        mkdir -p dist/BotPersonal-${{ steps.version.outputs.VERSION }}-windows
        copy dist\BotPersonal.exe dist\BotPersonal-${{ steps.version.outputs.VERSION }}-windows\
        copy requirements.txt dist\BotPersonal-${{ steps.version.outputs.VERSION }}-windows\
        copy README.md dist\BotPersonal-${{ steps.version.outputs.VERSION }}-windows\
        copy VERSION dist\BotPersonal-${{ steps.version.outputs.VERSION }}-windows\
        powershell -NoProfile -Command "Compress-Archive -Path 'dist\BotPersonal-${{ steps.version.outputs.VERSION }}-windows' -DestinationPath 'dist\BotPersonal-${{ steps.version.outputs.VERSION }}-windows.zip'"

    - name: Create Linux package
      if: runner.os == 'Linux'
      run: |
        mkdir -p dist/BotPersonal-${{ steps.version.outputs.VERSION }}-linux
        cp dist/BotPersonal dist/BotPersonal-${{ steps.version.outputs.VERSION }}-linux/
        cp requirements.txt dist/BotPersonal-${{ steps.version.outputs.VERSION }}-linux/
        cp README.md dist/BotPersonal-${{ steps.version.outputs.VERSION }}-linux/
        cp VERSION dist/BotPersonal-${{ steps.version.outputs.VERSION }}-linux/
        tar -czf dist/BotPersonal-${{ steps.version.outputs.VERSION }}-linux.tar.gz \
          -C dist BotPersonal-${{ steps.version.outputs.VERSION }}-linux

    - name: Create macOS package
      if: runner.os == 'macOS'
      run: |
        mkdir -p dist/BotPersonal-${{ steps.version.outputs.VERSION }}-macos
        cp dist/BotPersonal dist/BotPersonal-${{ steps.version.outputs.VERSION }}-macos/
        cp requirements.txt dist/BotPersonal-${{ steps.version.outputs.VERSION }}-macos/
        cp README.md dist/BotPersonal-${{ steps.version.outputs.VERSION }}-macos/
        cp VERSION dist/BotPersonal-${{ steps.version.outputs.VERSION }}-macos/
        tar -czf dist/BotPersonal-${{ steps.version.outputs.VERSION }}-macos.tar.gz \
          -C dist BotPersonal-${{ steps.version.outputs.VERSION }}-macos

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: BotPersonal-${{ steps.version.outputs.VERSION }}-${{ runner.os }}
        path: dist/
        retention-days: 30

    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*
        body: |
          # Bot Personal v${{ steps.version.outputs.VERSION }}
          
          ## Features
          - Gestión de gastos con OCR de facturas
          - Múltiples criterios de extracción
          - Sistema de plantillas Jinja2
          - Tests automatizados (100% exitosos)
          
          ## Packages Included
          - Windows executable
          - Linux binary
          - macOS binary
          - Source code
          
          ## Installation
          Download the package for your OS and follow the README.md
          
          **Note**: Requires Python 3.9+ if running from source
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

